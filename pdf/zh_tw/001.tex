\chapter{計算機啟動} \label{CHboot}

每一個計算機軟體都是由一系列的可執行檔案組成的，可執行檔案的內容是可以被機器識別的二進制指令和數據。一般可執行檔案的執行是在作業系統的管理下載入記憶體並執行的，由作業系統給它分配資源和處理器時間，並確定它的執行方式。作業系統也是由可執行檔案組成的，但是作業系統的啟動方式和一般應用軟體是不同的，這也就是它叫做``作業系統''的原因~\smiley。

沒有作業系統的機器，一般情況下被我們稱為``裸機''，意思就是只有硬體，什麼都幹不了。但是一個機器怎麼知道自己是不是裸機呢？它總要有方式去判斷機器上安裝沒有安裝作業系統吧。下面我們就簡單介紹一下計算機啟動的過程：

\section{計算機啟動過程} \label{CHboot_boot}

\textbf{計算機啟動過程}一般是指計算機從點亮到載入作業系統的一個過程。對于~IBM~兼容機（個人電腦）來講，這個過程大致是這樣的：

\begin{enumerate}
\item{\textbf{加電}} 電源開關被按下時，機器就開始供電，主板的控制芯片組會向~CPU~（Central Processing Unit，中央處理器）發出並保持一個~RESET~（重置）信號，讓~CPU~恢復到初始狀態。當芯片組檢測到電源已經開始穩定供電時就會撤去~RESET~信號（鬆開台式機的重啟鍵是一樣的效果），這時~CPU~就從~\code{0xffff0}~處開始執行指令。這個地址在系統~BIOS~（Basic Input/Output System，基本輸入輸出系統）的地址範圍內，大部分系統~BIOS~廠商放在這裡的都只是一道跳轉指令，跳到系統~BIOS~真正的啟動程式碼處。

\item{\textbf{自檢}} 系統~BIOS~的啟動代碼首先要做的事情就是進行~POST~（Power-On Self Test，加電後自檢），POST~的主要任務是檢測系統中一些關鍵設備是否存在和能否正常工作，例如記憶體和顯示卡等。由于~POST~是最早進行的檢測過程，此時顯示卡還沒有初始化，如果系統~BIOS~在~POST~的過程中發現了一些致命錯誤，例如沒有找到記憶體或者記憶體有問題（此時只會檢查~640K~常規記憶體），那麼系統~BIOS~就會直接控制喇叭發聲來報告錯誤，聲音的長短和次數代表了錯誤的類型。

\item{\textbf{初始化設備}} 接下來系統~BIOS~將查找顯示卡的 BIOS，存放顯示卡~BIOS~的~ROM~芯片的起始地址通常設在~\code{0xC0000}~處，系統~BIOS~在這個地方找到顯示卡 ~BIOS~之後就調用它的初始化代碼，由顯示卡~BIOS~來初始化顯示卡，此時多數顯示卡都會在屏幕上顯示出一些初始化信息，介紹生產廠商、圖形芯片類型等內容。系統~BIOS~接著會查找其它設備的~BIOS~程序，找到之後同樣要調用這些~BIOS~內部的初始化代碼來初始化相關的設備。

\item{\textbf{測試設備}} 查找完所有其它設備的~BIOS~之後，系統~BIOS~將顯示出它自己的啟動畫面，其中包括有系統~BIOS~的類型、序列號和版本號等內容。接著系統~BIOS~將檢測和顯示~CPU~的類型和工作頻率，然後開始測試所有的~RAM~（Random Access Memory，隨機訪問存儲器），並同時在屏幕上顯示記憶體測試的進度。記憶體測試通過之後，系統~BIOS~將開始檢測系統中安裝的一些標準硬體設備，包括硬碟、光驅、串口、並口、軟驅等，另外絕大多數較新版本的系統~BIOS~在這一過程中還要自動檢測和設置記憶體的定時參數、硬碟參數和訪問模式等。標準設備檢測完畢後，系統~BIOS~內部的支持即插即用的代碼將開始檢測和配置系統中安裝的即插即用設備，每找到一個設備之後，系統~BIOS~都會在屏幕上顯示出設備的名稱和型號等信息，同時為該設備分配中斷（INT）、DMA~（Direct Memory Access，直接存儲器存取）通道和~I/O~（Input/Output，輸入輸出）端口等資源。

\item{\textbf{更新~ESCD}} 所有硬體都檢測配置完畢後，多數系統~BIOS~會重新清屏並在屏幕上方顯示出一個表格，其中概略地列出了系統中安裝的各種標準硬體設備，以及它們使用的資源和一些相關工作參數。接下來系統~BIOS~將更新~ESCD~（Extended System Configuration Data，擴展系統配置數據）。~ESCD~是系統~BIOS~用來與作業系統交換硬體配置信息的一種手段，這些數據被存放在~CMOS~（Complementary Metal Oxide Semiconductor，互補金屬氧化物半導體）之中。

\item{\textbf{啟動作業系統}} \label{bootsec-1} ~ESCD~更新完畢後，系統~BIOS~的啟動代碼將進行它的最後一項工作，即根據用戶指定的啟動順序從軟碟、硬碟或光驅啟動作業系統。以~Windows XP~為例，系統~BIOS~將啟動盤（一般是主硬碟）的第一個扇區（Boot Sector，引導扇區）讀入到記憶體的~\code{0x7c00}~處，並檢查~\code{0x7dfe}~地址的記憶體，如果其內容是~\code{0xaa55}，跳轉到~\code{0x7c00}~處執行~MBR~（Master Boot Record，主引導記錄），MBR~接著從分區表（Partition Table）中找到第一個活動分區（Active Partition，一般是~C~盤分區），然後按照類似方式讀取並執行這個活動分區的引導扇區（Partition Boot Sector），而引導扇區將負責讀取並執行~NTLDR~（NT LoaDeR，Windows NT~的載入程序），然後主動權就移交給了~Windows~。
\end{enumerate}

從以上介紹中我們可以看到，在第~\ref{bootsec-1}~步之前，電腦的啟動過程完全依仗于系統~BIOS~，這個程序一般是廠商寫就固化在主板上的。我們所需要做的，就是第~\ref{bootsec-1}~步之後的內容，即：
\begin{quote}
\textbf{如何寫一個作業系統並把它載入到記憶體?}
\end{quote}

\section{磁盤抽象物理結構}\label{disk_structure}

由于作業系統的啟動涉及到硬體地址寫入和磁盤文件尋找，為了更好理解記憶體地址和文件存儲的相關知識，我們先來了解一下磁盤的結構。

\subsection{硬碟}

\FIGFIX{硬碟}{hd1}{0.8\textwidth}

圖~\ref{hd1}~所示就是硬碟（如非特指，我們這裡的“硬碟”一般指代磁介質非固態硬碟）的外觀圖。其中左邊是硬碟盒拆開後盤片、磁頭和內部機械結構的透視圖，右邊是普通台式機硬碟的外觀圖。現在的硬碟容量較以前已經有大幅度增加，一般筆記本電腦硬碟容量已經在~120G~以上，台式機硬碟容量一般也達到了~160G~大小。一般情況下，硬碟都是由堅硬金屬材料（或者玻璃等）制成的塗以磁性介質的盤片構成的，一般有層疊的多片，每個盤片都有兩個面，兩面都可以記錄信息。

\FIGFIX{硬碟的抽象物理結構}{hd2}{13.04cm}

圖~\ref{hd2}~為硬碟的抽象物理結構，需要注意的是這並不是硬碟真正的物理構造，所以這裡我們稱其為“抽象”物理結構。因此我們下面討論的也不是真正的硬碟技術實現，僅僅就硬碟（以及軟碟等類似磁介質存儲器）存儲結構以程序員易于理解的角度進行簡單的介紹。

如圖~\ref{hd2}~所示，硬碟是由很多盤片組成的，那些上下有分割的圓盤就表示一個個盤片。每個盤片被分成許多扇形的區域，每個區域叫一個扇區，通常每個扇區存儲~512~字節（~FAT~文件格式），盤片表面上以盤片中心為圓心，不同半徑的同心圓稱為磁道。硬碟中，不同盤片相同半徑的磁道所組成的圓柱稱為柱面。磁道與柱面都是表示不同半徑的圓，在許多場合，磁道和柱面可以互換使用。每個磁盤有兩個面，每個面都有一個磁頭，習慣用磁頭號來區分。扇區，磁道（或柱面）和磁頭數構成了硬碟結構的基本參數，使用這些參數可以得到硬碟的容量，其計算公式為：
\begin{quote}
存儲容量~＝~磁頭數~×~磁道（柱面）數~×~每磁道扇區數~×~每扇區字節數
\end{quote}

\BOXED{0.9\textwidth}{
\textbf{要點：}
\begin{itemize} 
\item 硬碟有數個盤片，每盤片兩個面，每面一個磁頭。
\item 盤片被劃分為多個扇形區域即扇區。
\item 同一盤片不同半徑的同心圓為磁道。
\item 不同盤片相同半徑構成的圓柱面即柱面。
\item 公式：存儲容量~＝~磁頭數~×~磁道（柱面）數~×~每道扇區數~×~每扇區字節數。
\item 信息記錄可表示為：××磁道（柱面），××磁頭，××扇區。
\end{itemize}
}

\subsection{軟碟}
由于我們在本書中主要使用軟碟作為系統啟動盤，所以下面對應于硬碟介紹一下軟碟的相關知識。

\FIG{軟碟}{floppy1}{0.8\textwidth}

現在通常能看到的軟碟主要是~3.5~英寸軟碟，3.5~英寸指的是其內部磁介質盤片的直徑。從存儲結構上來講，軟碟與硬碟的主要不同就是軟碟只有一個盤片且其存儲密度較低。

由于軟碟只有一個盤片，兩個面，所以~3.5~英寸軟碟的容量可以根據上一小節的公式算出：

2(磁頭)~×~80(磁道)~×~18(扇區)~×~512 bytes(扇區的大小)~=~2880 x 512 bytes = 1440 KB = 1.44MB

在這裡需要引起我們特別注意的就是第~0~號磁頭（面），第~0~號磁道的第~0~號扇區，這裡是一切的開始。

\subsection{啟動扇區}

軟碟是沒有所謂的~MBR~的，因為軟碟容量較小，沒有所謂的分區，一張軟碟就顯示為一個邏輯磁盤。當我們使用軟碟啟動電腦的時候，系統從軟碟中首先讀取的就是第一個扇區，即前面所說的第~0~面，第~0~號磁道的第~0~號扇區，如果這個扇區的最後兩個字節是~\code{0xaa55}~，這裡就簡單叫做啟動扇區（Boot Sector）。所以我們首先要做的就是：在啟動扇區的開始填入需要被執行的機器指令；在啟動扇區的最後兩個字節中填入~\code{0xaa55}，這樣這張軟碟就成為了一張可啟動盤。

\BOXED{0.9\textwidth}{
\danger啟動扇區最後兩個字節的內容為~\code{0xaa55}~，這種說法是正確的---當且僅當表~\ref{bootsec_BPB}~中的~BPB\_BytesPerSec~（每扇區字節數）的值為~512~。如果~BPB\_BytesPerSec~的值大于~512~，~\code{0xaa55}~的位置不會變化，但已經不是啟動扇區最後兩個字節了。\enddanger
}

整個過程如圖~\ref{bootsector1}~所示：

\FIG{啟動扇區載入示意圖}{bootsector1}{0.75\textwidth}

需要注意的是，軟碟的啟動扇區並不像一個文件一樣，可以直接讀取，寫入啟動扇區的過程是需要一些技巧的，下面我們將討論如何去實現。

\section{使用虛擬機}

在實現一個簡單的作業系統時，我們是不可能拿一台真正的機器做實驗的，一是很少有人有這個條件，還有就是那樣做比較麻煩。所以我們使用虛擬機來模擬一台真實的電腦，這樣我們就能直接用虛擬機載入軟碟鏡像來啟動了，而制作軟碟鏡像顯然要比寫一張真實的軟碟簡單許多。

在~Linux~下有很多虛擬機軟體，我們選擇~VirtualBox~和~Bochs~作為主要的實現平台，我們用~VirtualBox~做~demo~，而~Bochs~主要用作調試。下面給出一些虛擬機設置的指導，其實用哪種虛擬機都沒有關系，我們需要的只是虛擬機支持載入軟碟鏡像並能從軟碟啟動。

\subsection{VirtualBox}

~VirtualBox~是遵從~GPL~協議的開源軟體，它的官方網站是~\url{http://www.virtualbox.org}~。~VirtualBox~的官方網站上提供針對很多~Linux~系統平台的二進制安裝包，比如針對~Red Hat~系列（Fedora, RHEL）各種版本的~RPM~安裝包，針對~Debian~系（Debian, Ubuntu）各種版本的~DEB~安裝包，其中~Ubuntu
Linux~可以更方便地從~Ubuntu~軟體倉庫中直接下載安裝：~\code{sudo apt-get install virtualbox}~。

安裝好~VirtualBox~後，需要使用~\code{sudo adduser `whoami` vboxusers}~（某些系統中的添加用戶命令可能是~useradd~）將自己添加到~VirtualBox~的用戶組~vboxusers~中去；當然，也可以使用~GNOME~或者~KDE~的圖形界面用戶和組的管理工具來添加組用戶，也可以直接編輯~/etc/group~文件，將自己的用戶名添加到~vboxusers~對應行的最後，例如~\code{vboxusers:x:501:solrex}~，部分~Linux~可能需要注銷後重新登錄當前用戶。

我們下面使用~CentOS~上安裝的~VirtualBox~演示如何用它建立一個虛擬機。

第一次啟動~VirtualBox~，會首先彈出一個~VirtualBox~個人使用協議~PUEL~的對話框（某些版本的~Linux~可能不會彈出）：\\
\FIGFIX{VirtualBox~個人使用協議}{vb_once_1}{0.7\textwidth}

閱讀完協議後，將下拉條拉到最低可以激活最下方的同意按鈕，點擊之：\\
\FIGFIX{同意~VirtualBox~個人使用協議}{vb_once_2}{0.7\textwidth}

彈出的~VirtualBox~用戶注冊對話框，可忽視關閉之：\\
\FIGFIX{VirtualBox~用戶注冊對話框}{vb_once_3}{0.75\textwidth}

接下來我們就見到了~VirtualBox~主界面：\\
\FIGFIX{VirtualBox~主界面}{vb_main_1}{0.75\textwidth}

點擊~New~按鈕新建一個虛擬機：\\
\FIGFIX{新建一個虛擬機}{vb_new_1}{0.75\textwidth}

我們使用~solrex~作為虛擬機的名字，系統類型未知：\\
\FIGFIX{設置虛擬機名字和作業系統類型}{vb_new_2}{0.75\textwidth}

設置虛擬機的記憶體容量，這裡隨便設了~32M：\\
\FIGFIX{設置虛擬機記憶體容量}{vb_new_3}{0.75\textwidth}

設置虛擬機硬碟鏡像：\\
\FIGFIX{設置虛擬機硬碟鏡像}{vb_new_4}{0.75\textwidth}

如果沒有硬碟鏡像，需點“New”新建一塊硬碟鏡像：\\
\FIGFIX{新建一塊虛擬硬碟}{vb_newhd_1}{0.75\textwidth}

點“Next”，設置虛擬硬碟鏡像為可自動擴充大小：\\
\FIGFIX{設置虛擬硬碟類型}{vb_newhd_2}{0.75\textwidth}

這裡將虛擬硬碟鏡像的名字設置為“solrex”，並將容量設置為“32M”：\\
\FIGFIX{設置虛擬硬碟鏡像名字和容量}{vb_newhd_3}{0.75\textwidth}

最後查看新建的虛擬硬碟信息，點擊~Finish~確認新建硬碟鏡像：\\
\FIGFIX{虛擬硬碟信息}{vb_newhd_4}{0.75\textwidth}

令虛擬機使用已建立的虛擬硬碟~solrex.vdi~：\\
\FIGFIX{使用新建的虛擬硬碟}{vb_new_5}{0.75\textwidth}

最後查看新建的虛擬機信息，點擊~Finish~確認新建虛擬機：\\
\FIGFIX{虛擬機信息}{vb_new_6}{0.75\textwidth}

回到~VirtualBox~主界面，左側列表中有新建立的虛擬機~solrex~：\\
\FIGFIX{回到~VirtualBox~主界面}{vb_main_2}{0.75\textwidth}

\subsection{Bochs}

\section{使用軟碟鏡像}

\subsection{制作軟碟鏡像}
前面我們說過，軟碟的結構比較簡單，所以我們選擇使用軟碟鏡像來啟動虛擬計算機。在~Linux~下制作一個軟碟鏡像很簡單，只需要使用：
\begin{Command}
$ dd if=/dev/zero of=emptydisk.img bs=512 count=2880
\end{Command}
命令就可以在當前目錄下生成一個名為~\code{emptydisk.img}~的空白軟碟鏡像，下面我們使用這個空白軟碟鏡像來啟動虛擬機。

\BOXED{0.9\textwidth}{

~~~~\textbf{dd}~：轉換和拷貝文件的工具。~dd~可以設置很多拷貝時候的參數，在本例中~if=FILE~選項代表從~FILE~中讀取內容；~of=FILE~選項代表將導出輸出到~FILE~；~bs=BYTES~代表每次讀取和輸出~BYTES~個字節；~count=BLOCKS~代表從輸入文件中共讀取~BLOCKS~個輸入塊。

~~~~而這裡的~/dev/zero~則是一個~Linux~的特殊文件，讀取這個文件可以得到持續的~0~。那麼上面命令的意思就是以每塊~512~字節共~2880~塊全空的字符填入文件~emptydisk.img~中。我們注意到前面提及的軟碟容量計算公式：

~~~~2(磁頭)~×~80(磁道)~×~18(扇區)~×~512 bytes(扇區的大小)~=~2880 x 512 bytes = 1440 KB = 1.44MB

~~~~可以發現我們用上述命令得到的就是一張全空的未格式化的軟碟鏡像。
}

\subsection{用軟碟鏡像啟動虛擬機}\label{CHboot_fboot}

在虛擬機主界面選中虛擬機後點~Settings~按鈕，進入虛擬機的設置界面：\\
\FIGFIX{虛擬機設置界面}{vb_set_1}{0.75\textwidth}

在左側列表中選擇~Floppy~進入虛擬機軟碟設置界面：\\
\FIGFIX{虛擬機軟碟設置}{vb_set_2}{0.75\textwidth}

點擊~Image File~最右側的文件夾標志，進入選擇軟碟鏡像界面：\\
\FIGFIX{選擇軟碟鏡像}{vb_set_3}{0.75\textwidth}

點擊~Add~按鈕添加新的軟碟鏡像~emptydisk.img，並點擊~select~按鈕選中其作為啟動軟碟：\\
\FIGFIX{選擇啟動軟碟鏡像}{vb_set_4}{0.75\textwidth}

返回虛擬機軟碟設置界面後，點擊~OK~確認鏡像文件信息：\\
\FIGFIX{確認啟動鏡像軟碟文件信息}{vb_set_5}{0.75\textwidth}

返回虛擬機主界面，查看右側的虛擬機設置信息：\\
\FIGFIX{查看虛擬機設置信息}{vb_main_3}{0.75\textwidth}

選中虛擬機後，雙擊或點擊~Start~按鈕執行它，第一次執行可能給出如下信息：\\
\FIGFIX{自動鍵盤捕獲警告信息}{vb_once_4}{0.75\textwidth}

這個對話框的意思就是，當鼠標在虛擬機內部點擊時，鼠標和鍵盤的消息將被虛擬機自動捕獲，成為虛擬機的鍵盤和鼠標，可以敲擊鍵盤右側的~Ctrl~鍵解除捕獲。

顯示虛擬機的執行時內容：\\
\FIGFIX{虛擬機執行時}{vb_run_1}{0.75\textwidth}

我們可以看到在圖~\ref{vb_run_1}~中，虛擬機載入空白軟碟啟動後提示消息為：“FATAL: No bootable medium found! System halted.”，換成中文是找不到可啟動媒體，系統停機。它的實際意思就是在前面第~\ref{CHboot_boot}~節“計算機啟動過程”中提到的第~\ref{bootsec-1}~步中虛擬機遍歷了軟驅、光驅、硬碟後沒有找到可啟動的媒體，所以就只好停機。因為我們在啟動前已經在軟驅中載入了軟碟鏡像，所以提示信息就表明那個軟碟鏡像不具有啟動系統的功能，那麼如何才能創建一個可啟動的軟碟呢，我們將在第~\ref{CHsmall}~章介紹。

